"use strict";(self.webpackChunkwp_travel_engine=self.webpackChunkwp_travel_engine||[]).push([[5266],{5266:(e,t,a)=>{a.r(t),a.d(t,{default:()=>c});const i=lodash,{api:r,util:s,priceFormat:o,dateFormat:n}=window.wteL10n,c=class{constructor(e){var t,a=this;this.bookingform=e,this.summaryTemplate=wp.template("wte-booking-summary"),this.datetimeTemplate=wp.template("wte-booking-datetime"),this.state={selectedPackage:null,selectedDate:n(null),selectedTime:n(null),packageCategories:{},travelerRecord:{},availablePackages:[],availableTimes:[],extraServices:{},loading:!0,defaultDateFormat:"YYYY-MM-DD",cart:{},formatPrice:function(e){const{currency:t,baseCurrency:a,currencySymbol:i,format:{number:r,price:s}}=wteL10n;let o={[a]:1};if("undefined"!=typeof wteCc&&wteCc?.code)for(let e in wteCc.code)o={...o,[wteCc.code[e]]:wteCc.rate[e]};return e*=+o[t],wteL10n.helpers.priceFormat(e,t,i,s,+r.decimal,r.decimalSeparator,r.thousandSeparator)},groupPricings:{},cartTotal:{travelers:0}},this.extraServicesAPI=(t=this,()=>{let e=t._store,{trip:a}=e.getState();if(a.trip_extras.length<1)return;document.getElementById("wte-booking-extraservices-content").innerHTML=wp.template("wte-booking-extraservices")(),e.subscribe((()=>{let t=e.getState().services||{},a="";for(let i in t){let r=t[i],s=r?.meta.wte_services.service_type;a+=wp.template(`wte-booking-es-${s}`)({service:r,extraServices:e.getState().extraServices})}document.getElementById("wte-booking-extraservices__services").innerHTML=a,document.getElementById("wte-booking-es-summary-content").innerHTML=wp.template("wte-booking-es-summary")(e.getState())})),e.dispatch(((t,i)=>{fetch(`${wteL10n.wpapi.root}${wteL10n.wpapi.versionString}wte-services?include=${a.trip_extras?.join(",")}`).then((t=>{t.json().then((t=>{t&&e.dispatch({type:"UPDATE_STORE",data:{services:lodash.keyBy(t,"id")}})}))}))}));const i=function(t){var a;let i=this,r=i.closest(".wte-booking-es-counter").dataset.info;r=r&&JSON.parse(r);let{serviceID:s,option:o}=r,n={[o]:1},c=0;if(i.classList.contains("wte-up"))c=1;else{if(!i.classList.contains("wte-down"))return;c=-1}let{extraServices:l,services:d,cartTotal:g,cart:p}=e.getState(),u=c>0?1:0;if(l[s]&&(u=c>0?l[s][o]?+l[s][o].count+1:1:l[s][o]?+l[s][o].count-1:0),u<0)return;let m=d[s]||{},f=null!==(a=m?.meta?.wte_services)&&void 0!==a?a:{},h=0,b="",v="unit";f?.service_type&&("custom"===f.service_type?(b=f.options[o],h=+f.prices[o],v=f.service_unit):(b=m.title.rendered,h=+f.service_cost,v=f.service_unit)),n={...l[s],[o]:{count:u<0?0:u,unitPrice:h,label:b,per:v}};let k={...l,[s]:n},w=0,T=[];for(let e in k){let t=k[e];for(let e in t){let a=t[e];w+=+a.count*+a.unitPrice,+a.count>0&&(T=[...T,{extra_service:a.label,qty:a.count,price:+a.unitPrice}])}}p={...p,extraServices:T},e.dispatch({type:"UPDATE_STORE",data:{extraServices:k,cartTotal:{...g,services:w},cart:p}})};s.on("change",".wte-booking-es-select",(function(t){let a=this,i=a.dataset.info;i=i&&JSON.parse(i);let{extraServices:r,services:s}=e.getState(),{serviceID:o,option:n}=i,{options:c,service_unit:l,prices:d}=s[o].meta.wte_services,g={};g={...r,[o]:{[a.value]:{count:0,label:c[a.value],per:l,unitPrice:d[a.value]}}},e.dispatch({type:"UPDATE_STORE",data:{extraServices:g}})})),s.on("click",".wte-booking-es-counter .wte-up",i),s.on("click",".wte-booking-es-counter .wte-down",i)}),this._store=Redux.createStore((function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.state,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case"SET_TRIP":return{...e,trip:t.data};case"UPDATE_STORE":return{...e,...t.data};case"SET_DATE":return{...e,selectedDate:t.date};case"SET_TIME":return{...e,selectedTime:t.data};case"SET_PACKAGE":return{...e,selectedPackage:t.data};case"SET_TRAVELER_RECORD":return{...e,travelerRecord:t.data};default:return e}}),Redux.applyMiddleware((e=>t=>a=>"function"==typeof a?a(e.dispatch,e.getState):t(a)))),this.unsubscriber=this._store.subscribe((()=>{!this._store.getState().loading&&this._store.getState().trip&&(console.info("Initialize Booking Process",this._store.getState()),this.init())})),this._store.subscribe((()=>{this.updateSelectedTime(),this.updateSummary(),this.updatePackageTabContent()})),this._store.dispatch(((e,t)=>{var a;let i=r.get("trip",{id:wte.trip.id}),s=r.get("categories"),o=null!==(a=i.packages_ids)&&void 0!==a?a:[],n=[];try{if(!o)throw new Error(`No packages assigned to this trip - ${i.id}`);n=r.get("packages",{trip_id:wte.trip.id,per_page:100})}catch(e){console.warn("WTEBOOKING: "+e.message)}Promise.all([i,s,n]).then((t=>{const[a,i,r]=t;e({type:"UPDATE_STORE",data:{loading:!1,trip:a,tripPackagesIds:a.packages_ids||[],tripPackages:r,pricingCategories:i,primaryCategory:Object.values(i).find((e=>e["is-primary"]))}})}))})),this.priceFormat=function(e){return o(e)},this.cart={},this.currentTab=0,this.tabController={},this.timeformat="h:mm A",this.timeformatter=e=>(wteL10n.format.datetime.timezone,moment(e).format(this.timeformat)),this.addToCart=async e=>{const{wpxhr:{root:t},tripID:a,_nonces:{addtocart:i}}=wteL10n;let{cart:r,selectedPackage:s,selectedDate:o,selectedTime:n,travelerRecord:c,cartTotal:l,packageCategories:d,groupPricings:g,trip:p}=this._store.getState();if(""!=p.min_pax&&+p.min_pax>r.traveler)return alert(wteL10n?.l10n?.invalidCartTraveler?.replace("%s",p.min_pax)),void e(!1);if(!r?.traveler||r.traveler<1)return alert(wteL10n?.l10n?.invalidCartTraveler?.replace("%s",1)),void e(!1);wteL10n.format.datetime.GMTOffset;let u=s,m=o.format("YYYY-MM-DD"),f=n.get()?n.format("YYYY-MM-DDTHH:mm"):"",h=c,b={};l=Object.values(l).reduce((function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;return+e+ +t}));for(let e in h){let t=h[e];if(t<1)continue;let a=d[e],i={pax:t,salePrice:a?.salePrice?+a.salePrice:0,groupDiscountPrice:0,cost:+a.price};if(a.enabledSale&&(i.cost=a.salePrice),a.enabledGroupDiscount&&g&&g[e])for(let r of g[e]){if(r.to.length<1){i.cost=r.price.length>0?+r.price:+a.price;break}if(t>=+r.from&&t<=+r.to){i.cost=r.price.length>0?+r.price:+a.price;break}}i.categoryInfo=a,b={...b,[e]:i}}r={...r,nonce:i,tripID:a,packageID:u,tripDate:m,tripTime:f,travelers:h,cartTotal:l,pricingOptions:b,cversion:wteL10n?.cart_version||"2.0"};const v=await fetch(`${t}?action=wte_add_trip_to_cart&cart_version=${r.cversion}&_nonce=${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),k=await v.json();k.success?window.location.href=window?.wp_travel_engine?.CheckoutURL:(k.data&&k.data[0]&&alert(k.data[0]),e(!1))}}init(){this.unsubscriber(),this.loadTemplates(),this.initTabController(),this.initCalendar(),this.eventListeners(),this.bookingProcessFlowControl()}initTabController(){var e=this;let t=this.bookingform.querySelectorAll(".wte-process-nav-item"),a=this.bookingform.querySelectorAll(".wte-process-tab-item");var i;this.tabController={tabCount:t?.length,navigators:t,activeTab:"wte-booking-datetime",activeClass:"active",completedClass:"finish",nextBtn:"#wteProcessNext",prevBtn:"#wteProcessPrev",toggleNextBtn:function(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const a=document.querySelector(e.nextBtn);a&&(a.disabled=t)},finalAction:(i=this,function(){let e=document.querySelector(i.tabController.nextBtn);e&&(e.disabled=!0,e.classList.add("btn-loading")),i.addToCart((function(t){e.disabled=!!t,e.classList.toggle("btn-loading",!!t)}))}),validToNextProcess:(e=>function(){let t=e.tabController,a=document.querySelector(t.nextBtn);switch(t.activeTab){case"wte-booking-datetime":const{selectedDate:t,availableTimes:i,selectedTime:r}=e._store.getState();return t&&t?.get()&&(Object.keys(i).length<1||Object.keys(i).length&&r?.get());case"wte-booking-packages":const{cart:s}=e._store.getState();return s?.traveler&&s.traveler>0?(a.disabled=!1,!0):(a.disabled=!0,!1);default:return!0}})(this),switchBtnText:function(){let e=WTEBooking.tabController,t=document.querySelector(e.nextBtn);e.getActiveTabIndex()>=e.tabCount-1?t.textContent=t.dataset.labelCheckout||"Add to Cart":t.textContent=t.dataset.labelDefault||"Continue"},getActiveTabIndex:function(){let e=document.getElementById(this.activeTab);return Array.prototype.indexOf.call(a,e)},handleProcessBtnClick:function(e){let t=WTEBooking.tabController;if(this.matches(t.prevBtn))t.activeTab=a[t.getActiveTabIndex()-1].id;else if(this.matches(t.nextBtn)){let e=t.getActiveTabIndex()+1;if(e>=t.tabCount)t.finalAction();else{let i=a[e].id;t.validToNextProcess()&&(t.activeTab=i)}}t.switchBtnText(),t.getActiveTabIndex()>0?document.querySelector(t.prevBtn).style.removeProperty("display"):document.querySelector(t.prevBtn).style.display="none",t.showActiveTab()},init:function(){let e=this;e.showActiveTab();let t=+e.getActiveTabIndex();t<1&&(document.querySelector(e.prevBtn).style.display="none"),document.querySelector(".wte-process-nav-list").style.setProperty("--step-bar-width",(t+1)/3*100+"%"),s.on("click",e.nextBtn,e.handleProcessBtnClick),s.on("click",e.prevBtn,e.handleProcessBtnClick)},showActiveTab:function(){let e=this,t=+e.getActiveTabIndex();if(t<0)t=0;else if(t>=e.tabCount)t=e.tabCount-1;else{document.querySelector(".wte-process-nav-list").style.setProperty("--step-bar-width",(t+1)/3*100+"%");for(let i in Array.from(e.navigators)){let r=e.navigators[i];if(i<=t){if(i<t?r.classList.add(e.completedClass):r.classList.add(e.activeClass),i==t){for(let e in Array.from(a))a[e].style.removeProperty("display");document.querySelector("a"===r.tagName.toLowerCase()?r.hash:r.dataset.target).style.display="block"}}else r.classList.remove(e.activeClass,e.completedClass)}}}},this.tabController.init()}getJSONData(){return{trip:this.trip,tripPackages:this.tripPackages,availablePackages:this.availablePackages,selectedPackage:this.selectedPackage,packageCategories:this.getPackageCategories(this.selectedPackage),travelerRecord:this.travelerRecord,groupPricings:this.selectedPackage?this.tripPackages[this.selectedPackage]["group-pricing"]:{},formatPrice:this.formatPrice,selectedDate:this.selectedDate,cartTotal:this.calculateCartTotal(),selectedTime:this.selectedTime,availableTimes:this.availableTimes,extraServices:this.extraServices}}loadTemplates(){document.getElementById("wte-booking-datetime-content").innerHTML=this.datetimeTemplate(this._store.getState()),document.getElementById("wte-booking-packages-content").innerHTML=wp.template("wte-booking-packages")(this._store.getState()),document.getElementById("wte-booking-summary").innerHTML=wp.template("wte-booking-summary")(this._store.getState()),document.dispatchEvent(new Event("wteLoadBookingTemplates"))}calculateCartTotal(){let e=this.travelerRecord,t=0;for(let i in e){let r=e[i],s=this.getPackageCategories(this.selectedPackage)[i],o=s.enabledSale?+s.salePrice:+s.price,n=this.selectedPackage?this.tripPackages[this.selectedPackage]["group-pricing"]:{};if(Object.keys(n).length>0&&n[i]){var a=n[i];for(let e of a){if(e.to.length<1){o=e.price||o;break}if(+r>=+e.from&&+r<=+e.to){o=e.price;break}}}t+=o*+r}return t}eventListeners(){var e;s.on("click",".wte-package-select-btn",(e=this,function(t){let a=this.dataset.packageId,{tripPackages:i}=e._store.getState();const r=e.getDefaultCart(a);e._store.dispatch({type:"UPDATE_STORE",data:{selectedPackage:a,packageCategories:e.getPackageCategories(a),groupPricings:a?i[a]["group-pricing"]:{},...r}})}));const t=e=>function(t){let a=this,i=0;if(a.classList.contains("wte-up"))i=1;else{if(!a.classList.contains("wte-down"))return;i=-1}let{travelerRecord:r,cart:s,cartTotal:o,packageCategories:n,tripPackages:c,selectedPackage:l,trip:d,selectedTime:g,selectedDate:p,parentDateConfig:u}=e._store.getState(),m={...s},f={...r},h=a.parentElement.dataset.info;h=h&&JSON.parse(h);const b=h.catID;if(f[b]<1&&i<0)return;let v=0;if(i>0?(v=f[b]?+f[b]+1:1,m.traveler=m?.traveler?+m.traveler+1:1):(v=f[b]&&f[b]>=1?+f[b]-1:0,m.traveler=m?.traveler?+m.traveler-1:0),v<0)return;let k=n[b].minPax;k&&v<k&&(m.traveler=m.traveler-i*(1-k),v=i<0?0:k);let w=n[b].maxPax;if(w&&v>w&&(m.traveler=m.traveler-1,v=w),""!=d.max_pax&&+d.max_pax<m.traveler)return void alert(wteL10n?.l10n?.availableSeatsExceed?.replace("%s",d.max_pax));let T=-1;if(g.get()){let e=g.format("YYYY-MM-DD-HH-mm-ss").split("-");e[1]=e[1]-1,T=.001*new Date(Date.UTC(...e)).getTime()}else if(p?.get()){let e=p.format("YYYY-MM-DD").split("-");e[1]=e[1]-1,T=.001*new Date(Date.UTC(...e)).getTime()}if(u&&d["booked-seats"]&&d["booked-seats"][T]&&parseInt(d["booked-seats"][T]?.booked)){const e=u&&u?._seats?parseInt(u._seats)-parseInt(d["booked-seats"][T].booked):-1;if(""!==u._seats&&e>-1&&e<m.traveler)return void alert(wteL10n?.l10n?.availableSeatsExceed?.replace("%s",e))}else if(u&&parseInt(u._seats)<+m.traveler)return void alert(wteL10n?.l10n?.availableSeatsExceed?.replace("%s",u._seats));f={...f,[b]:v};let _=0;for(let e in f){let t=f[e],a=n[e],i=a.enabledSale?+a.salePrice:+a.price,r=c[l]["group-pricing"]||{};if(a.enabledGroupDiscount&&Object.keys(r).length>0&&r[e]){var y=r[e];for(let e of y){if(e.to.length<1){i=e.price||i;break}if(+t>=+e.from&&+t<=+e.to){i=e.price;break}}}_+="per-group"===a.pricingType?t&&+i||0:i*+t}e._store.dispatch({type:"UPDATE_STORE",data:{travelerRecord:f,cart:m,cartTotal:{...o,travelers:_}}})};s.on("click",".wte-booking-pc-counter .wte-down",t(this)),s.on("click",".wte-booking-pc-counter .wte-up",t(this)),s.on("click",".wte-time-select-btn",(e=>function(t){let a=this.dataset.time,i=this.dataset.packageId.split(","),{tripPackages:r}=e._store.getState();if(e?.tabController?.nextBtn){const t=document.querySelector(e.tabController.nextBtn);t&&(t.disabled=!1)}a&&e._store.dispatch({type:"UPDATE_STORE",data:{selectedTime:n(new Date(+a)),availablePackages:i.map((e=>r[e])),selectedPackage:i[0]}})})(this))}getPackageCategories(e){if(!e)return{};let{tripPackages:t}=this._store.getState();return t[e]["package-categories"]}clear(){this._store.dispatch({type:"UPDATE_STORE",data:{selectedDate:n(null),selectedTime:n(null),selectedPackage:null,defaultDateFormat:"YYYY-MM-DD",packageCategories:{},travelerRecord:{},cart:{}}})}updateSelectedTime(){document.getElementById("wte-booking-times-content").innerHTML=wp.template("wte-booking-times")(this._store.getState())}getDefaultCart(e){if(!e)return;let{tripPackages:t,trip:a}=this._store.getState();const i=this.getPackageCategories(e),r={};let s={traveler:0},o=0;const n=a?.primary_category;if(!i[n])return{cart:s,cartTotal:{travelers:o},travelerRecord:r};let c=i[n],l=n,d=c.enabledSale?+c.salePrice:+c.price,g=parseInt(c.minPax);r[l]=g;let p=t[e]["group-pricing"]||{};if(c.enabledGroupDiscount&&Object.keys(p).length>0&&p[l]){var u=p[l];for(let e of u){if(e.to.length<1){d=e.price||d;break}if(g>=+e.from&&g<=+e.to){d=e.price;break}}}return s.traveler=parseInt(s.traveler)+g,o+="per-group"===c.pricingType?g&&+d||0:d*g,{cart:s,cartTotal:{travelers:o},travelerRecord:r}}bookingProcessFlowControl(e){const t=this;e||this.bookingform.classList.add("wte-bp-flow");const a=document.getElementById("wte-booking-datetime"),i={dateChange:function(){if(a&&t.bookingform.classList.contains("wte-bp-flow")){const e=a.offsetHeight;let t=a.children;if(t[0]){let i=t[0].offsetHeight,r=function(){a.scrollTop<i-e&&(a.scrollTop=i-e>a.scrollTop?a.scrollTop+10:a.scrollTop,setTimeout(r))};r()}}}};i[e]&&i[e]()}initCalendar(){let e=this.getPackagesDates();const t=Object.values(e._nodates);delete e._nodates;let{tripPackages:a,trip:i,cart:r}=this._store.getState();console.debug({_dates:e});let s=e._minDate;delete e._minDate;let o={minDate:s,inline:!0,onChange:(t,r)=>{t[0].getTimezoneOffset(),t=new Date(t[0].getTime());let s=moment(t).format("YYYY-MM-DD");this.clear();let o=[];e[s]&&(o=Object.keys(e[s]).map((e=>a[e])));const c=Object.values(a).filter((e=>Object.values(e["package-dates"]).length<1));o=[...o,...c];let l=o.map((e=>e.id)),d=i?.packages_ids?.find((e=>l.indexOf(e)>-1))||o[0].id,g={};const p=this.getDefaultCart(d),u=e[s]&&e[s][d]||null;if(e[s])for(let[a,r]of Object.entries(e[s])){let e=r;if(!(e._times.length<1))for(let r in e._times){let s=e._times[r],o=s?.from?.split(":"),n=new Date(t);n.setHours(o[0]),n.setMinutes(o[1]);let c=s?.to?.split(":"),l=new Date(t);l.setHours(c[0]),l.setMinutes(c[1]);let d="_"+moment(n).format("HH-mm")+"_"+moment(l).format("HH-mm");if(g[d]){g[d].packages=[...g[d].packages,a];continue}let m=!0;const f=i["booked-seats"],h=.001*n.getTime();if(f&&f[h]){m=!!f[h]?.booked&&+f[h]?.booked>0;let e=u?._seats&&f[h]?.booked?+u._seats-+f[h].booked:-1;m=!p?.cart?.traveler&&e>0&&e>p?.cart?.traveler}g[d]={from:n,to:l,packages:[a],formatter:this.timeformatter,isAvailable:m}}}const m=document.querySelector(this.tabController?.nextBtn);t&&Object.values(g).length<=0?m&&(m.disabled=!1):m&&(m.disabled=!0),this._store.dispatch({type:"UPDATE_STORE",data:{...p,parentDateConfig:u,selectedDate:n(t),availablePackages:o,selectedPackage:d,availableTimes:g,packageCategories:this.getPackageCategories(d),groupPricings:d?a[d]["group-pricing"]:{}}}),this.bookingProcessFlowControl("dateChange")},disable:[e=>!1],onReady:function(){const e=document.getElementById("open-booking-modal");if(e&&(e.disabled=!1),window.location.search?.split("&").indexOf("action=fsd_booking")>-1){let t=window.location.search?.replace("?","").split("&").map((e=>e.split("="))).find((e=>"date"===e[0]));e.click(),(arguments.length<=2?void 0:arguments[2])?.setDate(t,!0)}document.dispatchEvent(new Event("bookingCalendarReady"))}};o.disable=[(e=>{let a=s;return i=>!(!s||t.length>0&&moment(i).isSameOrAfter(a)||e[moment(i).format("YYYY-MM-DD")])})({...e})],flatpickr("#wte-booking-date-calendar",o)}formatPrice(e){const{currency:t,baseCurrency:a,currencySymbol:i,format:{number:r,price:s}}=wteL10n;let o={[a]:1};if("undefined"!=typeof wteCc&&wteCc?.code)for(let e in wteCc.code)o={...o,[wteCc.code[e]]:wteCc.rate[e]};return e*=+o[t],wteL10n.helpers.priceFormat(e,t,i,s,+r.decimal,r.decimalSeparator,r.thousandSeparator)}updateSummary(){document.getElementById("wte-booking-summary").innerHTML=wp.template("wte-booking-summary")(this._store.getState())}updatePackageTabContent(){document.getElementById("wte-booking-packages-content").innerHTML=wp.template("wte-booking-packages")(this._store.getState())}_dateToUTC(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("invalid date"!==(e=new Date(moment(e).tz("utc").toDate())).toString().toLowerCase()){let a=0,i=0;if(t){let e=t.split(":");a=+e[0],i=+e[1]}return new Date(Date.UTC(e.getUTCFullYear(),e.getMonth(),e.getDate(),a,i,0,0))}return e}_dateToTripTimeZone(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("invalid date"!==(e=new Date(e)).toString().toLowerCase()){if(e.setHours(0),e.setMinutes(0),e.setSeconds(0),t){let a=t.split(":");e.setHours(+a[0]),e.setMinutes(+a[1])}let a=`${moment(e).format("YYYY-MM-DDTHH:mm:ss")}${wteL10n.format.datetime.timezone}`;return new Date(a)}return e}getPackagesDates(){const{tripPackages:e,trip:t}=this._store.getState();let a={_nodates:[]},r=new Date;r.setHours(0),r.setMinutes(0),r.setSeconds(0),r.setMilliseconds(0),t.cut_off_time?.enabled&&(r=moment(r).add(t.cut_off_time.duration,t.cut_off_time.duration_unit).toDate());for(let s in e){let o=e[s]["package-dates"];if(o&&Object.values(o).length<1)a._nodates=[...a._nodates,s];else for(let e in o){let n=o[e],c=i.get(n,"dtstart",null);c=c.split("-");let l=new Date(Date.UTC(c[0],+c[1]-1,c[2],0,0,0,0)),d=l.getTime(),g=l;const p=i.get(n,"times",[]),u=i.get(n,"rrule",{}),m=!!i.get(n,"is_recurring",!1),f=i.get(n,"seats","");if(moment(g).isSameOrAfter(r)){let e=.001*d;if(""!==f&&t["booked-seats"]&&t["booked-seats"][+e]&&parseInt(t["booked-seats"][+e].booked)>=+f);else{let e=c.join("-");(!a._minDate||+a._minDate>moment(e).valueOf())&&(a._minDate=moment(e).valueOf()),a[e]={...a[e]?a[e]:{},[s]:{_times:p,_rrule:u,_isRecurring:m,_seats:f}}}}if(!m)continue;const{r_frequency:h,r_until:b,r_weekdays:v,r_months:k,r_count:w}=null!=u?u:{};let T={freq:h?rrule.RRule[h.toUpperCase()]:rrule.RRule.DAILY,dtstart:l};if(b){let e=this._dateToUTC(b);if(moment(r).isAfter(e))continue;T.until=e}switch(b||(T.count=w?+w:10),h){case"WEEKLY":T.byweekday=v&&Object.values(v).map((e=>rrule.RRule[e]))||[];break;case"MONTHLY":T.bymonth=k&&Object.keys(k).map((e=>+e))||[]}let _=new rrule.RRule(T).all(),y=0;for(let e in _){let i=_[e];if(moment(i.getTime()).isBefore(r))continue;0==e&&(y=T.dtstart.getTime()-i.getTime());let o=i.getTime()+y;if(""!==f&&t["booked-seats"]&&t["booked-seats"][o]&&parseInt(t["booked-seats"][o].booked)>=+f)continue;let n=moment.tz(moment(i).toISOString(),"UTC").format("YYYY-MM-DD"),c=moment(n).valueOf();(!a._minDate||+a._minDate>c)&&(a._minDate=c),a[n]={...a[n]?a[n]:{},[s]:{_times:p,_rrule:u,_isRecurring:m,_seats:f}}}}}return a._minDate||(a._minDate=r),a}async fetchData(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.trip=await r.get("trip",{id:wte.trip.id}),this.tripPackagesIds=this.trip.packages_ids||[];try{if("object"!=typeof tripPackagesIds)throw`Trip Error: No Packages Assign to the trip - ${this.trip.id}.`;this.tripPackages=await r.get("packages",{include:this.tripPackagesIds.join(","),per_page:100})}catch(e){this.tripPackages=[],console.debug(`WTE Booking: ${e.message}`)}this.pricingCategories=await r.get("categories"),e&&e()}}}}]);